<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Cookbook/make-ts-fast">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Make TypeScript Fast | Lage</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://microsoft.github.io/lage/docs/Cookbook/make-ts-fast"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Make TypeScript Fast | Lage"><meta data-rh="true" name="description" content="version 2"><meta data-rh="true" property="og:description" content="version 2"><link data-rh="true" rel="icon" href="/lage/img/lage-logo.svg"><link data-rh="true" rel="canonical" href="https://microsoft.github.io/lage/docs/Cookbook/make-ts-fast"><link data-rh="true" rel="alternate" href="https://microsoft.github.io/lage/docs/Cookbook/make-ts-fast" hreflang="en"><link data-rh="true" rel="alternate" href="https://microsoft.github.io/lage/docs/Cookbook/make-ts-fast" hreflang="x-default"><link rel="stylesheet" href="/lage/assets/css/styles.92b36086.css">
<link rel="preload" href="/lage/assets/js/runtime~main.7b2bdbce.js" as="script">
<link rel="preload" href="/lage/assets/js/main.47168870.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_oPtH" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/lage/"><div class="navbar__logo"><img src="/lage/img/lage.png" alt="Lage Logo" class="themedImage_BQGR themedImage--light_HAxW"><img src="/lage/img/lage.png" alt="Lage Logo" class="themedImage_BQGR themedImage--dark_bGx0"></div></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/lage/docs/Introduction">Guide</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/microsoft/lage" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPrP"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_ki11 colorModeToggle_Hewu"><button class="clean-btn toggleButton_MMFG toggleButtonDisabled_Uw7m" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_lgto"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_U96C"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_WqAV"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_MB5r docsWrapper_ct1J"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_iEvu" type="button"></button><div class="docPage_KLoz"><aside class="theme-doc-sidebar-container docSidebarContainer_y0RQ"><div class="sidebar_CUen"><nav class="menu thin-scrollbar menu_jmj1"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item green"><a class="menu__link" href="/lage/docs/Introduction">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/lage/docs/Quick Start">Quick Start</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/lage/docs/Tutorial/">Tutorial</a><button aria-label="Toggle the collapsible sidebar category &#x27;Tutorial&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/lage/docs/Reference/cli">Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/lage/docs/Contributing/packages">Contributing</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/lage/docs/Cookbook/migration">Cookbook</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/lage/docs/Cookbook/migration">Migration Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/lage/docs/Cookbook/make-jest-fast">Make Jest Fast</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/lage/docs/Cookbook/make-lint-fast">Make ESLint Fast</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/lage/docs/Cookbook/make-ts-fast">Make TypeScript Fast</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_sTIZ"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_Qr34"><div class="docItemContainer_tjFy"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_T5ub" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/lage/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_GlTw"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Cookbook</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Make TypeScript Fast</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_wXna theme-doc-toc-mobile tocMobile_Ojys"><button type="button" class="clean-btn tocCollapsibleButton_iI2p">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Make TypeScript Fast</h1></header><span class="inline-block px-3 py-1 text-xs font-semibold leading-tight text-gray-800 bg-gray-200 rounded-full mb-8">version 2</span><p>TypeScript is a superset on top of JavaScript that adds type safety checks and a downlevel conversion of modern ECMAScript-like syntax with types to a target ECMAScript level. In a monorepo, we are interested in how to accelerate two aspects of TypeScript: transpilation and type checking. Let&#x27;s go!</p><h2 class="anchor anchorWithStickyNavbar_JmGV" id="fastest-transpilation">Fastest transpilation<a class="hash-link" href="#fastest-transpilation" title="Direct link to heading">​</a></h2><p>TypeScript&#x27;s npm package <code>typescript</code> comes with a CLI program called <code>tsc</code>. This program will do type checking as well as transpilation. We can configure it to transpile code only. This would speed up the compilation by doing work on a file-by-file basis (not quite true, but close enough):</p><pre class="shiki min-light" style="background-color:#ffffff;color:#24292eff"><div class="code-container"><code><div class="line"><span style="color:undefined">tsc -p some-package/tsconfig.json --isolatedModules</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff"><div class="code-container"><code><div class="line"><span style="color:undefined">tsc -p some-package/tsconfig.json --isolatedModules</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><p>This is something you can place inside your package&#x27;s <code>package.json</code> like so:</p><pre class="shiki min-light" style="background-color:#ffffff;color:#24292eff"><div class="code-container"><code><div class="line"><span style="color:undefined">// @filename package.json</span></div><div class="line"><span style="color:undefined"></span></div><div class="line"><span style="color:undefined">{</span></div><div class="line"><span style="color:undefined">  &quot;scripts&quot;: {</span></div><div class="line"><span style="color:undefined">    &quot;transpile&quot;: &quot;tsc -p some-package/tsconfig.json --isolatedModules&quot;</span></div><div class="line"><span style="color:undefined">  }</span></div><div class="line"><span style="color:undefined">}</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff"><div class="code-container"><code><div class="line"><span style="color:undefined">// @filename package.json</span></div><div class="line"><span style="color:undefined"></span></div><div class="line"><span style="color:undefined">{</span></div><div class="line"><span style="color:undefined">  &quot;scripts&quot;: {</span></div><div class="line"><span style="color:undefined">    &quot;transpile&quot;: &quot;tsc -p some-package/tsconfig.json --isolatedModules&quot;</span></div><div class="line"><span style="color:undefined">  }</span></div><div class="line"><span style="color:undefined">}</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><p>Recently, many pure transpilers have been made to make transpilation even faster. You can use any of these packages: <code>swc</code> (Rust based), <code>esbuild</code> (Go based), <code>sucrase</code> (Node.js based). In this document, we will show one of the packages listed - <code>swc</code>:</p><pre class="shiki min-light" style="background-color:#ffffff;color:#24292eff"><div class="code-container"><code><div class="line"><span style="color:undefined"># if you use npm</span></div><div class="line"><span style="color:undefined">$ npm i -D @swc/cli @swc/core</span></div><div class="line"><span style="color:undefined"></span></div><div class="line"><span style="color:undefined"># if you use yarn</span></div><div class="line"><span style="color:undefined">$ yarn add -D @swc/cli @swc/core</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff"><div class="code-container"><code><div class="line"><span style="color:undefined"># if you use npm</span></div><div class="line"><span style="color:undefined">$ npm i -D @swc/cli @swc/core</span></div><div class="line"><span style="color:undefined"></span></div><div class="line"><span style="color:undefined"># if you use yarn</span></div><div class="line"><span style="color:undefined">$ yarn add -D @swc/cli @swc/core</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><pre class="shiki min-light" style="background-color:#ffffff;color:#24292eff"><div class="code-container"><code><div class="line"><span style="color:undefined">// @filename package.json</span></div><div class="line"><span style="color:undefined"></span></div><div class="line"><span style="color:undefined">{</span></div><div class="line"><span style="color:undefined">  &quot;scripts&quot;: {</span></div><div class="line"><span style="color:undefined">    &quot;transpile&quot;: &quot;swc ./src -d lib&quot;</span></div><div class="line"><span style="color:undefined">  }</span></div><div class="line"><span style="color:undefined">}</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff"><div class="code-container"><code><div class="line"><span style="color:undefined">// @filename package.json</span></div><div class="line"><span style="color:undefined"></span></div><div class="line"><span style="color:undefined">{</span></div><div class="line"><span style="color:undefined">  &quot;scripts&quot;: {</span></div><div class="line"><span style="color:undefined">    &quot;transpile&quot;: &quot;swc ./src -d lib&quot;</span></div><div class="line"><span style="color:undefined">  }</span></div><div class="line"><span style="color:undefined">}</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><p>You could also skip <code>@swc/cli</code> package, and make your own custom worker script (configure this inside the <code>lage.config.js</code> pipeline as a &quot;worker&quot; type):</p><pre class="shiki min-light" style="background-color:#ffffff;color:#24292eff"><div class="language-id">js</div><div class="code-container"><code><div class="line"><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">path</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">require</span><span style="color:#24292EFF">(</span><span style="color:#22863A">&quot;path&quot;</span><span style="color:#24292EFF">);</span></div><div class="line"><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">fs</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">require</span><span style="color:#24292EFF">(</span><span style="color:#22863A">&quot;fs/promises&quot;</span><span style="color:#24292EFF">);</span></div><div class="line"><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">swc</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">require</span><span style="color:#24292EFF">(</span><span style="color:#22863A">&quot;@swc/core&quot;</span><span style="color:#24292EFF">);</span></div><div class="line"></div><div class="line"><span style="color:#1976D2">module</span><span style="color:#24292EFF">.</span><span style="color:#1976D2">exports</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">async</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">function</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">transpile</span><span style="color:#24292EFF">(data) {</span></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> { </span><span style="color:#1976D2">target</span><span style="color:#24292EFF"> } </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> data;</span></div><div class="line"></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">queue</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> [</span><span style="color:#1976D2">target</span><span style="color:#24292EFF">.cwd];</span></div><div class="line"></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#C2C3C5">// recursively transpile everything in sight</span></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#D32F2F">while</span><span style="color:#24292EFF"> (</span><span style="color:#1976D2">queue</span><span style="color:#24292EFF">.</span><span style="color:#1976D2">length</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">&gt;</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">0</span><span style="color:#24292EFF">) {</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">dir</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">queue</span><span style="color:#6F42C1">.shift</span><span style="color:#24292EFF">();</span></div><div class="line"></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#D32F2F">let</span><span style="color:#24292EFF"> entries </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">await</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">fs</span><span style="color:#6F42C1">.readdir</span><span style="color:#24292EFF">(dir</span><span style="color:#212121">,</span><span style="color:#24292EFF"> { withFileTypes</span><span style="color:#D32F2F">:</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">true</span><span style="color:#24292EFF"> });</span></div><div class="line"></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#D32F2F">for</span><span style="color:#24292EFF"> (</span><span style="color:#D32F2F">let</span><span style="color:#24292EFF"> entry </span><span style="color:#D32F2F">of</span><span style="color:#24292EFF"> entries) {</span></div><div class="line"><span style="color:#24292EFF">      </span><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">fullPath</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">path</span><span style="color:#6F42C1">.join</span><span style="color:#24292EFF">(dir</span><span style="color:#212121">,</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">entry</span><span style="color:#24292EFF">.name);</span></div><div class="line"></div><div class="line"><span style="color:#24292EFF">      </span><span style="color:#C2C3C5">// some basic &quot;excluded directory&quot; list: node_modules, lib, tests, dist</span></div><div class="line"><span style="color:#24292EFF">      </span><span style="color:#D32F2F">if</span><span style="color:#24292EFF"> (</span><span style="color:#1976D2">entry</span><span style="color:#6F42C1">.isDirectory</span><span style="color:#24292EFF">() </span><span style="color:#D32F2F">&amp;&amp;</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">entry</span><span style="color:#24292EFF">.name </span><span style="color:#D32F2F">!==</span><span style="color:#24292EFF"> </span><span style="color:#22863A">&quot;node_modules&quot;</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">&amp;&amp;</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">entry</span><span style="color:#24292EFF">.name </span><span style="color:#D32F2F">!==</span><span style="color:#24292EFF"> </span><span style="color:#22863A">&quot;lib&quot;</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">&amp;&amp;</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">entry</span><span style="color:#24292EFF">.name </span><span style="color:#D32F2F">!==</span><span style="color:#24292EFF"> </span><span style="color:#22863A">&quot;tests&quot;</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">&amp;&amp;</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">entry</span><span style="color:#24292EFF">.name </span><span style="color:#D32F2F">!==</span><span style="color:#24292EFF"> </span><span style="color:#22863A">&quot;dist&quot;</span><span style="color:#24292EFF">) {</span></div><div class="line"><span style="color:#24292EFF">        </span><span style="color:#1976D2">queue</span><span style="color:#6F42C1">.push</span><span style="color:#24292EFF">(fullPath);</span></div><div class="line"><span style="color:#24292EFF">      } </span></div><div class="line"><span style="color:#24292EFF">      </span><span style="color:#C2C3C5">// if file extension is .ts - you maybe want to include .tsx here as well for repos that have TSX files</span></div><div class="line"><span style="color:#24292EFF">      </span><span style="color:#D32F2F">else</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">if</span><span style="color:#24292EFF"> (</span><span style="color:#1976D2">entry</span><span style="color:#6F42C1">.isFile</span><span style="color:#24292EFF">() </span><span style="color:#D32F2F">&amp;&amp;</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">entry</span><span style="color:#6F42C1">.</span><span style="color:#1976D2">name</span><span style="color:#6F42C1">.endsWith</span><span style="color:#24292EFF">(</span><span style="color:#22863A">&quot;.ts&quot;</span><span style="color:#24292EFF">)) {</span></div><div class="line"><span style="color:#24292EFF">        </span><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">swcOutput</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">await</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">swc</span><span style="color:#6F42C1">.transformFile</span><span style="color:#24292EFF">(fullPath);</span></div><div class="line"><span style="color:#24292EFF">        </span><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">dest</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">fullPath</span><span style="color:#6F42C1">.replace</span><span style="color:#24292EFF">(</span><span style="color:#22863A">/([/\\])src/</span><span style="color:#212121">,</span><span style="color:#24292EFF"> </span><span style="color:#22863A">&quot;$1lib&quot;</span><span style="color:#24292EFF">)</span><span style="color:#6F42C1">.replace</span><span style="color:#24292EFF">(</span><span style="color:#22863A">&quot;.ts&quot;</span><span style="color:#212121">,</span><span style="color:#24292EFF"> </span><span style="color:#22863A">&quot;.js&quot;</span><span style="color:#24292EFF">);</span></div><div class="line"><span style="color:#24292EFF">        </span><span style="color:#D32F2F">await</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">fs</span><span style="color:#6F42C1">.mkdir</span><span style="color:#24292EFF">(</span><span style="color:#1976D2">path</span><span style="color:#6F42C1">.dirname</span><span style="color:#24292EFF">(dest)</span><span style="color:#212121">,</span><span style="color:#24292EFF"> { recursive</span><span style="color:#D32F2F">:</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">true</span><span style="color:#24292EFF"> });</span></div><div class="line"><span style="color:#24292EFF">        </span><span style="color:#D32F2F">await</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">fs</span><span style="color:#6F42C1">.writeFile</span><span style="color:#24292EFF">(dest</span><span style="color:#212121">,</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">swcOutput</span><span style="color:#24292EFF">.code);</span></div><div class="line"><span style="color:#24292EFF">      }</span></div><div class="line"><span style="color:#24292EFF">    }</span></div><div class="line"><span style="color:#24292EFF">  }</span></div><div class="line"><span style="color:#24292EFF">};</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff"><div class="language-id">js</div><div class="code-container"><code><div class="line"><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">path</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">require</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">&quot;</span><span style="color:#A3BE8C">path</span><span style="color:#ECEFF4">&quot;</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">fs</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">require</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">&quot;</span><span style="color:#A3BE8C">fs/promises</span><span style="color:#ECEFF4">&quot;</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">swc</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">require</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">&quot;</span><span style="color:#A3BE8C">@swc/core</span><span style="color:#ECEFF4">&quot;</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"></div><div class="line"><span style="color:#8FBCBB">module</span><span style="color:#ECEFF4">.</span><span style="color:#8FBCBB">exports</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">async</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">function</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">transpile</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">data</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">target</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">data</span><span style="color:#81A1C1">;</span></div><div class="line"></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">queue</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> [</span><span style="color:#D8DEE9">target</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">cwd</span><span style="color:#D8DEE9FF">]</span><span style="color:#81A1C1">;</span></div><div class="line"></div><div class="line"><span style="color:#ECEFF4">  </span><span style="color:#616E88">// recursively transpile everything in sight</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">while</span><span style="color:#D8DEE9FF"> (</span><span style="color:#D8DEE9">queue</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">length </span><span style="color:#81A1C1">&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">0</span><span style="color:#D8DEE9FF">) </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">dir</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">queue</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">shift</span><span style="color:#D8DEE9FF">()</span><span style="color:#81A1C1">;</span></div><div class="line"></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">let</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">entries</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">await</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">fs</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">readdir</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">dir</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">withFileTypes</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">true</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">for</span><span style="color:#D8DEE9FF"> (</span><span style="color:#81A1C1">let</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">entry</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">of</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">entries</span><span style="color:#D8DEE9FF">) </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">fullPath</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">path</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">join</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">dir</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">entry</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">name</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"></div><div class="line"><span style="color:#ECEFF4">      </span><span style="color:#616E88">// some basic &quot;excluded directory&quot; list: node_modules, lib, tests, dist</span></div><div class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> (</span><span style="color:#D8DEE9">entry</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">isDirectory</span><span style="color:#D8DEE9FF">() </span><span style="color:#81A1C1">&amp;&amp;</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">entry</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">name</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">!==</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&quot;</span><span style="color:#A3BE8C">node_modules</span><span style="color:#ECEFF4">&quot;</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">&amp;&amp;</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">entry</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">name</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">!==</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&quot;</span><span style="color:#A3BE8C">lib</span><span style="color:#ECEFF4">&quot;</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">&amp;&amp;</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">entry</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">name</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">!==</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&quot;</span><span style="color:#A3BE8C">tests</span><span style="color:#ECEFF4">&quot;</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">&amp;&amp;</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">entry</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">name</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">!==</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&quot;</span><span style="color:#A3BE8C">dist</span><span style="color:#ECEFF4">&quot;</span><span style="color:#D8DEE9FF">) </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#D8DEE9">queue</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">push</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">fullPath</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF"> </span></div><div class="line"><span style="color:#ECEFF4">      </span><span style="color:#616E88">// if file extension is .ts - you maybe want to include .tsx here as well for repos that have TSX files</span></div><div class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">else</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> (</span><span style="color:#D8DEE9">entry</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">isFile</span><span style="color:#D8DEE9FF">() </span><span style="color:#81A1C1">&amp;&amp;</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">entry</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">name</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">endsWith</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">&quot;</span><span style="color:#A3BE8C">.ts</span><span style="color:#ECEFF4">&quot;</span><span style="color:#D8DEE9FF">)) </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">swcOutput</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">await</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">swc</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">transformFile</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">fullPath</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">dest</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">fullPath</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">replace</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">/([</span><span style="color:#EBCB8B">/\\</span><span style="color:#ECEFF4">])</span><span style="color:#EBCB8B">src</span><span style="color:#ECEFF4">/</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&quot;</span><span style="color:#A3BE8C">$1lib</span><span style="color:#ECEFF4">&quot;</span><span style="color:#D8DEE9FF">)</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">replace</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">&quot;</span><span style="color:#A3BE8C">.ts</span><span style="color:#ECEFF4">&quot;</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&quot;</span><span style="color:#A3BE8C">.js</span><span style="color:#ECEFF4">&quot;</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">await</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">fs</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">mkdir</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">path</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">dirname</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">dest</span><span style="color:#D8DEE9FF">)</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">recursive</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">true</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">await</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">fs</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">writeFile</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">dest</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">swcOutput</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">code</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#ECEFF4">}</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">}</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></div><div class="line"><span style="color:#ECEFF4">}</span><span style="color:#81A1C1">;</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><h2 class="anchor anchorWithStickyNavbar_JmGV" id="fastest-type-checking">Fastest Type Checking<a class="hash-link" href="#fastest-type-checking" title="Direct link to heading">​</a></h2><p>The industry is abuzz about how to replace TypeScript with a faster transpiler. There is still no open sourced TypeScript type checker that retains the full fidelity of the work that is done by <code>tsc</code>. TypeScript compiler is a single threaded program, so previously the fastest way to type check without caching (i.e fastest first run) is to flatten everything into a single TS program with all the TypeScript source files found inside monorepo. This indeed is currently the fastest way to type check, however, we can do better. In particular, we would like to have the best of these features of <code>lage</code>:</p><ol><li>remote cache</li><li>scope skipping</li><li>pipeline across workers (multi-core)</li></ol><p>A naive approach in achieving a faster build would have been to subdivide the TypeScript project by packages each with its own <code>tsc -p tsconfig.json</code> script inside a <code>build</code> script of a <code>package.json</code> file. It then would allow the project to be subdivided in smaller pieces that can be cached and executed in parallel topologically. This is subtly different than the project reference feature of TypeScript. </p><blockquote><p>:note: Project references are not preferable because it incurs an overhead of resolution of modules as well as having a tool-specific cache that isn&#x27;t hooked up with a remote cache</p></blockquote><p>This solution will scale to a certain degree of scale. The speed up is highly dependent on the shape of the package dependency graph. This is because (1) remote caching, (2) scope skipping, and even a distributed execution (not present in lage (yet?)) is highly dependent on the the shape of the graph. To truly achieve the optimal type checker that can compete with the single flattened TS project strategy is to see why it is faster. The answer is that TS is spending an large amount of time given a complex repo in re-processing source files. You can see this in an individual trace of a single package - much of the time is in &quot;ts.findSourceFile()&quot; processing the <code>d.ts</code> files from the package dependencies. Even with <code>skipLibCheck</code>, we still have to load type information from these module dependency into memory each time. A single compilation for all packages would have the ability to re-use this from memory.</p><p><code>lage</code> worker is here to rescue us from the single-threaded, no-remote-cache bleak state! <code>lage</code> has been applied inside various 10+ million lines of code repositories and has shown to cut type checking time by at least 2 (build agents are slower than local development machines):</p><pre class="shiki min-light" style="background-color:#ffffff;color:#24292eff"><div class="language-id">js</div><div class="code-container"><code><div class="line"><span style="color:#C2C3C5">// @filename tsc-worker.js</span></div><div class="line"></div><div class="line"><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">ts</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">require</span><span style="color:#24292EFF">(</span><span style="color:#22863A">&quot;typescript&quot;</span><span style="color:#24292EFF">);</span></div><div class="line"><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">path</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">require</span><span style="color:#24292EFF">(</span><span style="color:#22863A">&quot;path&quot;</span><span style="color:#24292EFF">);</span></div><div class="line"><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> { </span><span style="color:#1976D2">existsSync</span><span style="color:#24292EFF"> } </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">require</span><span style="color:#24292EFF">(</span><span style="color:#22863A">&quot;fs&quot;</span><span style="color:#24292EFF">);</span></div><div class="line"></div><div class="line"><span style="color:#C2C3C5">// Save the previously run ts.program to be fed inside the next call</span></div><div class="line"><span style="color:#D32F2F">let</span><span style="color:#24292EFF"> oldProgram;</span></div><div class="line"></div><div class="line"><span style="color:#D32F2F">let</span><span style="color:#24292EFF"> compilerHost;</span></div><div class="line"></div><div class="line"><span style="color:#C2C3C5">/** this is the patch to ts.compilerHost that retains sourceFiles in a Map **/</span></div><div class="line"><span style="color:#D32F2F">function</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">createCompilerHost</span><span style="color:#24292EFF">(compilerOptions) {</span></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">host</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">ts</span><span style="color:#6F42C1">.createCompilerHost</span><span style="color:#24292EFF">(compilerOptions</span><span style="color:#212121">,</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">true</span><span style="color:#24292EFF">);</span></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">sourceFiles</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">new</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">Map</span><span style="color:#24292EFF">();</span></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">originalGetSourceFile</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">host</span><span style="color:#24292EFF">.getSourceFile;</span></div><div class="line"></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#C2C3C5">// monkey patch host to cache source files</span></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#1976D2">host</span><span style="color:#24292EFF">.</span><span style="color:#6F42C1">getSourceFile</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> (</span></div><div class="line"><span style="color:#24292EFF">    fileName</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">    languageVersion</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">    onError</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">    shouldCreateNewSourceFile</span></div><div class="line"><span style="color:#24292EFF">  ) </span><span style="color:#D32F2F">=&gt;</span><span style="color:#24292EFF"> {</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#D32F2F">if</span><span style="color:#24292EFF"> (</span><span style="color:#1976D2">sourceFiles</span><span style="color:#6F42C1">.has</span><span style="color:#24292EFF">(fileName)) {</span></div><div class="line"><span style="color:#24292EFF">      </span><span style="color:#D32F2F">return</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">sourceFiles</span><span style="color:#6F42C1">.get</span><span style="color:#24292EFF">(fileName);</span></div><div class="line"><span style="color:#24292EFF">    }</span></div><div class="line"></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">sourceFile</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">originalGetSourceFile</span><span style="color:#24292EFF">(</span></div><div class="line"><span style="color:#24292EFF">      fileName</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">      languageVersion</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">      onError</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">      shouldCreateNewSourceFile</span></div><div class="line"><span style="color:#24292EFF">    );</span></div><div class="line"></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#1976D2">sourceFiles</span><span style="color:#6F42C1">.set</span><span style="color:#24292EFF">(fileName</span><span style="color:#212121">,</span><span style="color:#24292EFF"> sourceFile);</span></div><div class="line"></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#D32F2F">return</span><span style="color:#24292EFF"> sourceFile;</span></div><div class="line"><span style="color:#24292EFF">  };</span></div><div class="line"></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#D32F2F">return</span><span style="color:#24292EFF"> host;</span></div><div class="line"><span style="color:#24292EFF">}</span></div><div class="line"></div><div class="line"><span style="color:#D32F2F">async</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">function</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">tsc</span><span style="color:#24292EFF">(data) {</span></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> { </span><span style="color:#1976D2">target</span><span style="color:#24292EFF"> } </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> data; </span><span style="color:#C2C3C5">// Lage target data</span></div><div class="line"><span style="color:#24292EFF">  </span></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">pathString</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">path</span><span style="color:#6F42C1">.normalize</span><span style="color:#24292EFF">(</span><span style="color:#1976D2">target</span><span style="color:#24292EFF">.cwd);</span></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">packageString</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">pathString</span><span style="color:#6F42C1">.substring</span><span style="color:#24292EFF">(</span><span style="color:#1976D2">pathString</span><span style="color:#6F42C1">.lastIndexOf</span><span style="color:#24292EFF">(</span><span style="color:#22863A">&quot;\\&quot;</span><span style="color:#24292EFF">) </span><span style="color:#D32F2F">+</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">1</span><span style="color:#24292EFF">);</span></div><div class="line"></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">tsconfigFile</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#22863A">&quot;tsconfig.lage.json&quot;</span><span style="color:#24292EFF">;</span></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">tsconfigJsonFile</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">path</span><span style="color:#6F42C1">.join</span><span style="color:#24292EFF">(</span><span style="color:#1976D2">target</span><span style="color:#24292EFF">.cwd</span><span style="color:#212121">,</span><span style="color:#24292EFF"> tsconfigFile);</span></div><div class="line"></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#D32F2F">if</span><span style="color:#24292EFF"> (</span><span style="color:#D32F2F">!</span><span style="color:#6F42C1">existsSync</span><span style="color:#24292EFF">(tsconfigJsonFile)) {</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#C2C3C5">// this package has no tsconfig.json, skipping work!</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#D32F2F">return</span><span style="color:#24292EFF">;</span></div><div class="line"><span style="color:#24292EFF">  }</span></div><div class="line"></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#C2C3C5">// Parse tsconfig</span></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">configParserHost</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">parseConfigHostFromCompilerHostLike</span><span style="color:#24292EFF">(</span></div><div class="line"><span style="color:#24292EFF">    compilerHost </span><span style="color:#D32F2F">??</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">ts</span><span style="color:#24292EFF">.sys</span></div><div class="line"><span style="color:#24292EFF">  );</span></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">parsedCommandLine</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">ts</span><span style="color:#6F42C1">.getParsedCommandLineOfConfigFile</span><span style="color:#24292EFF">(</span></div><div class="line"><span style="color:#24292EFF">    tsconfigJsonFile</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">    {}</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">    configParserHost</span></div><div class="line"><span style="color:#24292EFF">  );</span></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#D32F2F">if</span><span style="color:#24292EFF"> (</span><span style="color:#D32F2F">!</span><span style="color:#24292EFF">parsedCommandLine) {</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#D32F2F">throw</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">new</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">Error</span><span style="color:#24292EFF">(</span><span style="color:#22863A">&quot;Could not parse tsconfig.json&quot;</span><span style="color:#24292EFF">);</span></div><div class="line"><span style="color:#24292EFF">  }</span></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">compilerOptions</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">parsedCommandLine</span><span style="color:#24292EFF">.options;</span></div><div class="line"></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#C2C3C5">// Creating compilation host program</span></div><div class="line"><span style="color:#24292EFF">  compilerHost </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> compilerHost </span><span style="color:#D32F2F">??</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">createCompilerHost</span><span style="color:#24292EFF">(compilerOptions);</span></div><div class="line"></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#C2C3C5">// The re-use of oldProgram is a trick we all learned from gulp-typescript, credit to ivogabe</span></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#C2C3C5">// @see https://github.com/ivogabe/gulp-typescript</span></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">program</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">ts</span><span style="color:#6F42C1">.createProgram</span><span style="color:#24292EFF">(</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#1976D2">parsedCommandLine</span><span style="color:#24292EFF">.fileNames</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">    compilerOptions</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">    compilerHost</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">    oldProgram</span></div><div class="line"><span style="color:#24292EFF">  );</span></div><div class="line"></div><div class="line"><span style="color:#24292EFF">  oldProgram </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> program;</span></div><div class="line"></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">errors</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> {</span></div><div class="line"><span style="color:#24292EFF">    semantics</span><span style="color:#D32F2F">:</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">program</span><span style="color:#6F42C1">.getSemanticDiagnostics</span><span style="color:#24292EFF">()</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">    declaration</span><span style="color:#D32F2F">:</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">program</span><span style="color:#6F42C1">.getDeclarationDiagnostics</span><span style="color:#24292EFF">()</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">    syntactic</span><span style="color:#D32F2F">:</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">program</span><span style="color:#6F42C1">.getSyntacticDiagnostics</span><span style="color:#24292EFF">()</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">    global</span><span style="color:#D32F2F">:</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">program</span><span style="color:#6F42C1">.getGlobalDiagnostics</span><span style="color:#24292EFF">()</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">  };</span></div><div class="line"></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">allErrors</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> [];</span></div><div class="line"></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#D32F2F">try</span><span style="color:#24292EFF"> {</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#1976D2">program</span><span style="color:#6F42C1">.emit</span><span style="color:#24292EFF">();</span></div><div class="line"><span style="color:#24292EFF">  } </span><span style="color:#D32F2F">catch</span><span style="color:#24292EFF"> (e) {</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#1976D2">console</span><span style="color:#6F42C1">.log</span><span style="color:#24292EFF">(</span><span style="color:#1976D2">e</span><span style="color:#24292EFF">.messageText);</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#D32F2F">throw</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">new</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">Error</span><span style="color:#24292EFF">(</span><span style="color:#22863A">&quot;Encountered errors while emitting&quot;</span><span style="color:#24292EFF">);</span></div><div class="line"><span style="color:#24292EFF">  }</span></div><div class="line"><span style="color:#24292EFF">  </span></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#D32F2F">let</span><span style="color:#24292EFF"> hasErrors </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">false</span><span style="color:#24292EFF">;</span></div><div class="line"></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#D32F2F">for</span><span style="color:#24292EFF"> (</span><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">kind</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">of</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">Object</span><span style="color:#6F42C1">.keys</span><span style="color:#24292EFF">(errors)) {</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#D32F2F">for</span><span style="color:#24292EFF"> (</span><span style="color:#D32F2F">const</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">diagnostics</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">of</span><span style="color:#24292EFF"> errors[kind]) {</span></div><div class="line"><span style="color:#24292EFF">      hasErrors </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">true</span><span style="color:#24292EFF">;</span></div><div class="line"><span style="color:#24292EFF">      </span><span style="color:#1976D2">allErrors</span><span style="color:#6F42C1">.push</span><span style="color:#24292EFF">(diagnostics);</span></div><div class="line"><span style="color:#24292EFF">    }</span></div><div class="line"><span style="color:#24292EFF">  }</span></div><div class="line"></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#D32F2F">if</span><span style="color:#24292EFF"> (hasErrors) {</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#1976D2">console</span><span style="color:#6F42C1">.log</span><span style="color:#24292EFF">(</span><span style="color:#1976D2">ts</span><span style="color:#6F42C1">.formatDiagnosticsWithColorAndContext</span><span style="color:#24292EFF">(allErrors</span><span style="color:#212121">,</span><span style="color:#24292EFF"> compilerHost))</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#D32F2F">throw</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">new</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">Error</span><span style="color:#24292EFF">(</span><span style="color:#22863A">&quot;Failed to compile&quot;</span><span style="color:#24292EFF">);</span></div><div class="line"><span style="color:#24292EFF">  } </span><span style="color:#D32F2F">else</span><span style="color:#24292EFF"> {</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#1976D2">console</span><span style="color:#6F42C1">.log</span><span style="color:#24292EFF">(</span><span style="color:#22863A">&quot;Compiled successfully\n&quot;</span><span style="color:#24292EFF">);</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#D32F2F">return</span><span style="color:#24292EFF">;</span></div><div class="line"><span style="color:#24292EFF">  }</span></div><div class="line"><span style="color:#24292EFF">}</span></div><div class="line"></div><div class="line"><span style="color:#D32F2F">function</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">parseConfigHostFromCompilerHostLike</span><span style="color:#24292EFF">(host) {</span></div><div class="line"><span style="color:#24292EFF">  </span><span style="color:#D32F2F">return</span><span style="color:#24292EFF"> {</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#6F42C1">fileExists</span><span style="color:#D32F2F">:</span><span style="color:#24292EFF"> f </span><span style="color:#D32F2F">=&gt;</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">host</span><span style="color:#6F42C1">.fileExists</span><span style="color:#24292EFF">(f)</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#6F42C1">readDirectory</span><span style="color:#24292EFF">(root</span><span style="color:#212121">,</span><span style="color:#24292EFF"> extensions</span><span style="color:#212121">,</span><span style="color:#24292EFF"> excludes</span><span style="color:#212121">,</span><span style="color:#24292EFF"> includes</span><span style="color:#212121">,</span><span style="color:#24292EFF"> depth) {</span></div><div class="line"><span style="color:#24292EFF">      </span><span style="color:#D32F2F">return</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">host</span><span style="color:#6F42C1">.readDirectory</span><span style="color:#24292EFF">(root</span><span style="color:#212121">,</span><span style="color:#24292EFF"> extensions</span><span style="color:#212121">,</span><span style="color:#24292EFF"> excludes</span><span style="color:#212121">,</span><span style="color:#24292EFF"> includes</span><span style="color:#212121">,</span><span style="color:#24292EFF"> depth);</span></div><div class="line"><span style="color:#24292EFF">    }</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#6F42C1">readFile</span><span style="color:#D32F2F">:</span><span style="color:#24292EFF"> f </span><span style="color:#D32F2F">=&gt;</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">host</span><span style="color:#6F42C1">.readFile</span><span style="color:#24292EFF">(f)</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">    useCaseSensitiveFileNames</span><span style="color:#D32F2F">:</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">host</span><span style="color:#24292EFF">.useCaseSensitiveFileNames</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">    getCurrentDirectory</span><span style="color:#D32F2F">:</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">host</span><span style="color:#24292EFF">.getCurrentDirectory</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#6F42C1">onUnRecoverableConfigFileDiagnostic</span><span style="color:#D32F2F">:</span><span style="color:#24292EFF"> d </span><span style="color:#D32F2F">=&gt;</span><span style="color:#24292EFF"> {</span></div><div class="line"><span style="color:#24292EFF">      </span><span style="color:#D32F2F">throw</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">new</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">Error</span><span style="color:#24292EFF">(</span><span style="color:#1976D2">ts</span><span style="color:#6F42C1">.flattenDiagnosticMessageText</span><span style="color:#24292EFF">(</span><span style="color:#1976D2">d</span><span style="color:#24292EFF">.messageText</span><span style="color:#212121">,</span><span style="color:#24292EFF"> </span><span style="color:#22863A">&quot;\n&quot;</span><span style="color:#24292EFF">));</span></div><div class="line"><span style="color:#24292EFF">    }</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">    trace</span><span style="color:#D32F2F">:</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">host</span><span style="color:#24292EFF">.trace</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">  };</span></div><div class="line"><span style="color:#24292EFF">}</span></div><div class="line"></div><div class="line"><span style="color:#1976D2">module</span><span style="color:#24292EFF">.</span><span style="color:#1976D2">exports</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> tsc;</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff"><div class="language-id">js</div><div class="code-container"><code><div class="line"><span style="color:#616E88">// @filename tsc-worker.js</span></div><div class="line"></div><div class="line"><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">ts</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">require</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">&quot;</span><span style="color:#A3BE8C">typescript</span><span style="color:#ECEFF4">&quot;</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">path</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">require</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">&quot;</span><span style="color:#A3BE8C">path</span><span style="color:#ECEFF4">&quot;</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">existsSync</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">require</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">&quot;</span><span style="color:#A3BE8C">fs</span><span style="color:#ECEFF4">&quot;</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"></div><div class="line"><span style="color:#616E88">// Save the previously run ts.program to be fed inside the next call</span></div><div class="line"><span style="color:#81A1C1">let</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">oldProgram</span><span style="color:#81A1C1">;</span></div><div class="line"></div><div class="line"><span style="color:#81A1C1">let</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">compilerHost</span><span style="color:#81A1C1">;</span></div><div class="line"></div><div class="line"><span style="color:#616E88">/** this is the patch to ts.compilerHost that retains sourceFiles in a Map **/</span></div><div class="line"><span style="color:#81A1C1">function</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">createCompilerHost</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">compilerOptions</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">host</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">ts</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">createCompilerHost</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">compilerOptions</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">true</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">sourceFiles</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">new</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">Map</span><span style="color:#D8DEE9FF">()</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">originalGetSourceFile</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">host</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">getSourceFile</span><span style="color:#81A1C1">;</span></div><div class="line"></div><div class="line"><span style="color:#ECEFF4">  </span><span style="color:#616E88">// monkey patch host to cache source files</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#D8DEE9">host</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">getSourceFile</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> (</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">fileName</span><span style="color:#ECEFF4">,</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">languageVersion</span><span style="color:#ECEFF4">,</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">onError</span><span style="color:#ECEFF4">,</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">shouldCreateNewSourceFile</span></div><div class="line"><span style="color:#D8DEE9FF">  ) </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> (</span><span style="color:#D8DEE9">sourceFiles</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">has</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">fileName</span><span style="color:#D8DEE9FF">)) </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">sourceFiles</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">get</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">fileName</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">}</span></div><div class="line"></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">sourceFile</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">originalGetSourceFile</span><span style="color:#D8DEE9FF">(</span></div><div class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">fileName</span><span style="color:#ECEFF4">,</span></div><div class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">languageVersion</span><span style="color:#ECEFF4">,</span></div><div class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">onError</span><span style="color:#ECEFF4">,</span></div><div class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">shouldCreateNewSourceFile</span></div><div class="line"><span style="color:#D8DEE9FF">    )</span><span style="color:#81A1C1">;</span></div><div class="line"></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">sourceFiles</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">set</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">fileName</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">sourceFile</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">sourceFile</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span><span style="color:#81A1C1">;</span></div><div class="line"></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">host</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#ECEFF4">}</span></div><div class="line"></div><div class="line"><span style="color:#81A1C1">async</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">function</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">tsc</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">data</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">target</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">data</span><span style="color:#81A1C1">;</span><span style="color:#D8DEE9FF"> </span><span style="color:#616E88">// Lage target data</span></div><div class="line"><span style="color:#D8DEE9FF">  </span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">pathString</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">path</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">normalize</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">target</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">cwd</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">packageString</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">pathString</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">substring</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">pathString</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">lastIndexOf</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">&quot;</span><span style="color:#EBCB8B">\\</span><span style="color:#ECEFF4">&quot;</span><span style="color:#D8DEE9FF">) </span><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">1</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">tsconfigFile</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&quot;</span><span style="color:#A3BE8C">tsconfig.lage.json</span><span style="color:#ECEFF4">&quot;</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">tsconfigJsonFile</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">path</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">join</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">target</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">cwd</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">tsconfigFile</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> (</span><span style="color:#81A1C1">!</span><span style="color:#88C0D0">existsSync</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">tsconfigJsonFile</span><span style="color:#D8DEE9FF">)) </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#ECEFF4">    </span><span style="color:#616E88">// this package has no tsconfig.json, skipping work!</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">return;</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></div><div class="line"></div><div class="line"><span style="color:#ECEFF4">  </span><span style="color:#616E88">// Parse tsconfig</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">configParserHost</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">parseConfigHostFromCompilerHostLike</span><span style="color:#D8DEE9FF">(</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">compilerHost</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">??</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">ts</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">sys</span></div><div class="line"><span style="color:#D8DEE9FF">  )</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">parsedCommandLine</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">ts</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">getParsedCommandLineOfConfigFile</span><span style="color:#D8DEE9FF">(</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">tsconfigJsonFile</span><span style="color:#ECEFF4">,</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">{},</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">configParserHost</span></div><div class="line"><span style="color:#D8DEE9FF">  )</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> (</span><span style="color:#81A1C1">!</span><span style="color:#D8DEE9">parsedCommandLine</span><span style="color:#D8DEE9FF">) </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">throw</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">new</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">Error</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">&quot;</span><span style="color:#A3BE8C">Could not parse tsconfig.json</span><span style="color:#ECEFF4">&quot;</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">compilerOptions</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">parsedCommandLine</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">options</span><span style="color:#81A1C1">;</span></div><div class="line"></div><div class="line"><span style="color:#ECEFF4">  </span><span style="color:#616E88">// Creating compilation host program</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#D8DEE9">compilerHost</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">compilerHost</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">??</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">createCompilerHost</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">compilerOptions</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"></div><div class="line"><span style="color:#ECEFF4">  </span><span style="color:#616E88">// The re-use of oldProgram is a trick we all learned from gulp-typescript, credit to ivogabe</span></div><div class="line"><span style="color:#ECEFF4">  </span><span style="color:#616E88">// @see https://github.com/ivogabe/gulp-typescript</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">program</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">ts</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">createProgram</span><span style="color:#D8DEE9FF">(</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">parsedCommandLine</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">fileNames</span><span style="color:#ECEFF4">,</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">compilerOptions</span><span style="color:#ECEFF4">,</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">compilerHost</span><span style="color:#ECEFF4">,</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">oldProgram</span></div><div class="line"><span style="color:#D8DEE9FF">  )</span><span style="color:#81A1C1">;</span></div><div class="line"></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#D8DEE9">oldProgram</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">program</span><span style="color:#81A1C1">;</span></div><div class="line"></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">errors</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">semantics</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">program</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">getSemanticDiagnostics</span><span style="color:#D8DEE9FF">()</span><span style="color:#ECEFF4">,</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">declaration</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">program</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">getDeclarationDiagnostics</span><span style="color:#D8DEE9FF">()</span><span style="color:#ECEFF4">,</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">syntactic</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">program</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">getSyntacticDiagnostics</span><span style="color:#D8DEE9FF">()</span><span style="color:#ECEFF4">,</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">global</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">program</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">getGlobalDiagnostics</span><span style="color:#D8DEE9FF">()</span><span style="color:#ECEFF4">,</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span><span style="color:#81A1C1">;</span></div><div class="line"></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">allErrors</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> []</span><span style="color:#81A1C1">;</span></div><div class="line"></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">try</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">program</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">emit</span><span style="color:#D8DEE9FF">()</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">catch</span><span style="color:#D8DEE9FF"> (</span><span style="color:#D8DEE9">e</span><span style="color:#D8DEE9FF">) </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">e</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">messageText</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">throw</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">new</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">Error</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">&quot;</span><span style="color:#A3BE8C">Encountered errors while emitting</span><span style="color:#ECEFF4">&quot;</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></div><div class="line"><span style="color:#D8DEE9FF">  </span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">let</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">hasErrors</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">false;</span></div><div class="line"></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">for</span><span style="color:#D8DEE9FF"> (</span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">kind</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">of</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">Object</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">keys</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">errors</span><span style="color:#D8DEE9FF">)) </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">for</span><span style="color:#D8DEE9FF"> (</span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">diagnostics</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">of</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">errors</span><span style="color:#D8DEE9FF">[</span><span style="color:#D8DEE9">kind</span><span style="color:#D8DEE9FF">]) </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">hasErrors</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">true;</span></div><div class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">allErrors</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">push</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">diagnostics</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">}</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></div><div class="line"></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> (</span><span style="color:#D8DEE9">hasErrors</span><span style="color:#D8DEE9FF">) </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">ts</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">formatDiagnosticsWithColorAndContext</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">allErrors</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">compilerHost</span><span style="color:#D8DEE9FF">))</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">throw</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">new</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">Error</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">&quot;</span><span style="color:#A3BE8C">Failed to compile</span><span style="color:#ECEFF4">&quot;</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">else</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">&quot;</span><span style="color:#A3BE8C">Compiled successfully</span><span style="color:#EBCB8B">\n</span><span style="color:#ECEFF4">&quot;</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">return;</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></div><div class="line"><span style="color:#ECEFF4">}</span></div><div class="line"></div><div class="line"><span style="color:#81A1C1">function</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">parseConfigHostFromCompilerHostLike</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">host</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">fileExists</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">f</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">host</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">fileExists</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">f</span><span style="color:#D8DEE9FF">)</span><span style="color:#ECEFF4">,</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">readDirectory</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">root</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">extensions</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">excludes</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">includes</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">depth</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">host</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">readDirectory</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">root</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">extensions</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">excludes</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">includes</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">depth</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">},</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">readFile</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">f</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">host</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">readFile</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">f</span><span style="color:#D8DEE9FF">)</span><span style="color:#ECEFF4">,</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">useCaseSensitiveFileNames</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">host</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">useCaseSensitiveFileNames</span><span style="color:#ECEFF4">,</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">getCurrentDirectory</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">host</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">getCurrentDirectory</span><span style="color:#ECEFF4">,</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">onUnRecoverableConfigFileDiagnostic</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">d</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">throw</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">new</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">Error</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">ts</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">flattenDiagnosticMessageText</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">d</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">messageText</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&quot;</span><span style="color:#EBCB8B">\n</span><span style="color:#ECEFF4">&quot;</span><span style="color:#D8DEE9FF">))</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">},</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">trace</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">host</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">trace</span><span style="color:#ECEFF4">,</span></div><div class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#ECEFF4">}</span></div><div class="line"></div><div class="line"><span style="color:#8FBCBB">module</span><span style="color:#ECEFF4">.</span><span style="color:#8FBCBB">exports</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">tsc</span><span style="color:#81A1C1">;</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_Ow0B padding--none margin-left--sm"><li class="tag_DFxh"><a class="tag_otG2 tagRegular_s0E1" href="/lage/docs/tags/version-2">version 2</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/microsoft/lage/docs/Cookbook/make-ts-fast.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_bHB7" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_pbO5"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/lage/docs/Cookbook/make-lint-fast"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Make ESLint Fast</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_XG6w thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#fastest-transpilation" class="table-of-contents__link toc-highlight">Fastest transpilation</a></li><li><a href="#fastest-type-checking" class="table-of-contents__link toc-highlight">Fastest Type Checking</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/lage/assets/js/runtime~main.7b2bdbce.js"></script>
<script src="/lage/assets/js/main.47168870.js"></script>
</body>
</html>